<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --error-color: #f72585;
            --success-color: #4cc9f0;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --black: #2A363B;
            --red: #F67280;
            --red-dark: #C06C84;
            --orange: #F8B195;
            --yellow: #FECEAB;
            --white: #FFF;
            --menu-width-desktop: 240px;
            --menu-width-tablet: 90px;
            --menu-width-smartphone: 230px;
            --menu-bg-color: var(--primary-color);
            --menu-text-color: var(--white);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: "Poppins", sans-serif;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #4a5568 100%);
            margin: 0;
            padding: 0;
            color: var(--dark-color);
            padding-left: var(--menu-width-desktop);
        }

        .container {
            max-width: 1050px;
            width: 90%;
            margin: auto;
        }

        .navbar {
            width: 100%;
            box-shadow: 0 1px 4px rgb(146 161 176 / 15%);
            background: white;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 62px;
            position: relative;
        }

        .navbar .menu-items {
            display: flex;
            padding-top: 120px;
            box-shadow: inset 0 0 2000px rgba(255, 255, 255, .5);
            height: 100vh;
            width: 100%;
            transform: translate(-150%);
            flex-direction: column;
            margin-left: -40px;
            padding-left: 50px;
            transition: transform 0.5s ease-in-out;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            background: white;
        }

        .navbar .nav-container li {
            list-style: none;
        }

        .navbar .nav-container a {
            text-decoration: none;
            color: #0e2431;
            font-weight: 500;
            font-size: 1.2rem;
            padding: 0.7rem;
        }

        .navbar .nav-container a:hover {
            font-weight: bolder;
        }

        .nav-container .checkbox {
            position: absolute;
            display: block;
            height: 32px;
            width: 32px;
            top: 20px;
            left: 20px;
            z-index: 5;
            opacity: 0;
            cursor: pointer;
        }

        .nav-container .hamburger-lines {
            display: block;
            height: 26px;
            width: 32px;
            position: absolute;
            top: 17px;
            left: 20px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .nav-container .hamburger-lines .line {
            display: block;
            height: 4px;
            width: 100%;
            border-radius: 10px;
            background: #0e2431;
        }

        .nav-container .hamburger-lines .line1 {
            transform-origin: 0% 0%;
            transition: transform 0.4s ease-in-out;
        }

        .nav-container .hamburger-lines .line2 {
            transition: transform 0.2s ease-in-out;
        }

        .nav-container .hamburger-lines .line3 {
            transform-origin: 0% 100%;
            transition: transform 0.4s ease-in-out;
        }

        .navbar .menu-items li {
            margin-bottom: 1.2rem;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .logo {
            position: absolute;
            top: 5px;
            right: 15px;
            font-size: 1.2rem;
            color: #0e2431;
        }

        .nav-container input[type="checkbox"]:checked ~ .menu-items {
            transform: translateX(0);
        }

        .nav-container input[type="checkbox"]:checked ~ .hamburger-lines .line1 {
            transform: rotate(45deg);
        }

        .nav-container input[type="checkbox"]:checked ~ .hamburger-lines .line2 {
            transform: scaleY(0);
        }

        .nav-container input[type="checkbox"]:checked ~ .hamburger-lines .line3 {
            transform: rotate(-45deg);
        }

        .nav-container input[type="checkbox"]:checked ~ .logo {
            display: none;
        }

        /* Adjust main content to account for fixed navbar */
        .main-content {
            margin-top: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .logout-btn {
            padding: 10px 20px;
            background-color: var(--error-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }

        .panel {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .panel h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            margin-right: 10px;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-complete {
            background-color: var(--success-color);
        }

        .btn-complete:hover {
            background-color: #00b4d8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #ffd166;
            color: #7a5900;
        }

        .status-in-progress {
            background-color: #06d6a0;
            color: #005744;
        }

        .status-completed {
            background-color: #118ab2;
            color: white;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
        }

        .file-icon {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }

        /* Schedule Styles */
        .schedule-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .schedule-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }
        .schedule-summary h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .schedule-summary p {
            margin: 5px 0;
            color: var(--dark-color);
        }
        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .time-input input {
            flex: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }

        /* File Links Styles */
        .file-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .file-icon {
            margin-right: 8px;
            color: var(--primary-color);
        }
        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9em;
        }
        .file-link:hover {
            text-decoration: underline;
        }

        .dashboard-content {
            display: flex;
            gap: 32px;
        }
        .dashboard-left {
            flex: 0 0 340px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        @media (max-width: 1100px) {
            .dashboard-content { flex-direction: column; }
            .dashboard-left, .dashboard-main { flex: 1 1 100%; }
        }
        .employee-details-box {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 24px 24px 16px 24px;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
        }
        .employee-scroll-row {
            display: flex;
            overflow-x: auto;
            gap: 32px;
            padding-bottom: 8px;
        }
        .employee-card {
            min-width: 120px;
            text-align: center;
            flex: 0 0 auto;
        }
        .employee-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            font-weight: 700;
            color: #4361ee;
            margin: 0 auto 8px auto;
        }
        .employee-name {
            font-size: 1rem;
            font-weight: 600;
            color: #222;
        }
        .employee-status {
            font-size: 0.95rem;
            color: #888;
            margin-top: 2px;
        }
        .calendar-panel {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 24px;
            margin-bottom: 32px;
        }
        #calendar {
            max-width: 100%;
            margin: 0 auto;
            height: 600px;
        }
        .employee-scroll-row::-webkit-scrollbar { display: none; }
        .employee-scroll-row { -ms-overflow-style: none; scrollbar-width: none; }

        .menu {
            background: var(--menu-bg-color);
            height: 100vh;
            width: var(--menu-width-desktop);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 5;
            outline: none;
        }

        .menu .avatar {
            background: rgba(0,0,0,0.1);
            padding: 2em 0.5em;
            text-align: center;
        }

        .menu .avatar img {
            width: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--white);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.2);
        }

        .menu .avatar h2 {
            font-weight: normal;
            margin-bottom: 0;
            color: var(--menu-text-color);
        }

        .menu ul {
            list-style: none;
            padding: 0.5em 0;
            margin: 0;
        }

        .menu ul li {
            padding: 0.5em 1em 0.5em 3em;
            font-size: 0.95em;
            font-weight: regular;
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: auto 20px;
            transition: all 0.15s linear;
            cursor: pointer;
            color: var(--menu-text-color);
        }

        .menu ul li:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .menu ul li:focus {
            outline: none;
        }

        .icon-dashboard { background-image: url('https://cdn-icons-png.flaticon.com/512/1946/1946488.png'); }
        .icon-tasks { background-image: url('https://cdn-icons-png.flaticon.com/512/2387/2387633.png'); }
        .icon-forward { background-image: url('https://cdn-icons-png.flaticon.com/512/2989/2989988.png'); }
        .icon-schedule { background-image: url('https://cdn-icons-png.flaticon.com/512/747/747310.png'); }

        @media screen and (max-width: 900px) and (min-width: 400px) {
            body {
                padding-left: var(--menu-width-tablet);
            }
            .menu {
                width: var(--menu-width-tablet);
            }
            .menu .avatar {
                padding: 0.5em;
                position: relative;
            }
            .menu .avatar img {
                width: calc(var(--menu-width-tablet) - 30px);
            }
            .menu .avatar h2 {
                opacity: 0;
                position: absolute;
                top: 50%;
                left: calc(var(--menu-width-tablet) + 10px);
                margin: 0;
                min-width: 200px;
                border-radius: 4px;
                background: rgba(0,0,0,0.4);
                transform: translate3d(-20px,-50%,0);
                transition: all 0.15s ease-in-out;
            }
            .menu .avatar:hover h2 {
                opacity: 1;
                transform: translate3d(0px,-50%,0);
            }
            .menu ul li {
                height: calc(var(--menu-width-tablet)/1.5);
                background-position: center center;
                background-size: 30px auto;
                position: relative;
            }
            .menu ul li span {
                opacity: 0;
                position: absolute;
                background: rgba(0,0,0,0.5);
                padding: 0.2em 0.5em;
                border-radius: 4px;
                top: 50%;
                left: calc(var(--menu-width-tablet) - 10px);
                transform: translate3d(-15px,-50%, 0);
                transition: all 0.15s ease-in-out;
            }
            .menu ul li span:before {
                content: '';
                width: 0;
                height: 0;
                position: absolute;
                top: 50%;
                left: -5px;
                border-top: 5px solid transparent;
                border-bottom: 5px solid transparent;
                border-right: 5px solid rgba(0,0,0,0.5);
                transform: translateY(-50%);
            }
            .menu ul li:hover span {
                opacity: 1;
                transform: translate3d(0px,-50%, 0);
            }
        }

        @media screen and (max-width: 400px) {
            body {
                padding-left: 0;
            }
            .menu {
                width: var(--menu-width-smartphone);
                box-shadow: 0 0 0 100em rgba(0,0,0,0);
                transform: translate3d(calc(-1 * var(--menu-width-smartphone)),0,0);
                transition: all 0.3s ease-in-out;
            }
            .menu .smartphone-menu-trigger {
                width: 40px;
                height: 40px;
                position: absolute;
                left: 100%;
                background: var(--menu-bg-color);
            }
            .menu .smartphone-menu-trigger:before,
            .menu .smartphone-menu-trigger:after {
                content: '';
                width: 50%;
                height: 2px;
                background: var(--menu-text-color);
                border-radius: 10px;
                position: absolute;
                top: 45%;
                left: 50%;
                transform: translate3d(-50%, -50%, 0);
            }
            .menu .smartphone-menu-trigger:after {
                top: 55%;
            }
            .menu ul li {
                padding: 1em 1em 1em 3em;
                font-size: 1.2em;
            }
            .menu:focus {
                transform: translate3d(0,0,0);
                box-shadow: 0 0 0 100em rgba(0,0,0,0.6);
            }
            .menu:focus .smartphone-menu-trigger {
                pointer-events: none;
            }
        }
    </style>
</head>
<body>
    <nav class="menu" tabindex="0">
        <div class="smartphone-menu-trigger"></div>
        <header class="avatar">
            <img src="https://s3.amazonaws.com/uifaces/faces/twitter/kolage/128.jpg" />
            <h2>John D.</h2>
        </header>
        <ul>
            <li tabindex="0" class="icon-dashboard" onclick="showSection('dashboard')"><span>Dashboard</span></li>
            <li tabindex="0" class="icon-tasks" onclick="showSection('tasks')"><span>My Tasks</span></li>
            <li tabindex="0" class="icon-forward" onclick="showSection('forward-project')"><span>Forward Project</span></li>
            <li tabindex="0" class="icon-schedule" onclick="showSection('schedule')"><span>Schedule</span></li>
        </ul>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>Employee Dashboard</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div id="dashboard" class="content-section active">
                <div class="dashboard-content">
                    <div class="dashboard-main">
                        <div class="calendar-panel">
                            <div style="font-size:1.2rem;font-weight:600;margin-bottom:12px;">My Calendar</div>
                            <div id="calendar"></div>
                        </div>
                        <div class="panel">
                            <h2>My Tasks</h2>
                            <table id="dashboardTasksTable">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Task</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tasks" class="content-section">
                <div class="panel">
                    <h2>My Tasks</h2>
                    <table id="tasksTable">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Task</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Files</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="forward-project" class="content-section">
                <div class="panel">
                    <h2>Forward Project</h2>
                    <form id="forwardProjectForm" class="schedule-form">
                        <div class="form-group">
                            <label for="projectSelect">Select Project:</label>
                            <select id="projectSelect" class="form-control" required>
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="departmentSelect">Forward To Department:</label>
                            <select id="departmentSelect" class="form-control" required>
                                <option value="">Select Department</option>
                                <option value="developer">Developer</option>
                                <option value="employee">Employee</option>
                                <option value="sales">Sales</option>
                                <option value="digital-marketing">Digital Marketing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="employeeSelectForward">Forward To Employee:</label>
                            <select id="employeeSelectForward" class="form-control">
                                <option value="">Select Employee (optional)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="forwardNotes">Notes:</label>
                            <textarea id="forwardNotes" class="form-control" rows="3" placeholder="Add any notes or instructions..." required></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn">Forward Project</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="sent-to" class="content-section">
                <div class="panel">
                    <h2>Sent To Manager</h2>
                    <table id="sentToTable">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Task</th>
                                <th>Sent Date</th>
                                <th>Status</th>
                                <th>Manager Response</th>
                                <th>Forwarded From</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="schedule" class="content-section">
                <div class="panel">
                    <h2>Work Schedule</h2>
                    <form id="scheduleForm" class="schedule-form">
                        <div class="form-group">
                            <label for="workDate">Date:</label>
                            <input type="date" id="workDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="startTime">Start Time:</label>
                            <input type="time" id="startTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time:</label>
                            <input type="time" id="endTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="taskSelect">Task:</label>
                            <select id="taskSelect" class="form-control" required>
                                <option value="">Select Task</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDescription">Work Description:</label>
                            <textarea id="workDescription" class="form-control" rows="3" placeholder="Describe what you worked on..." required></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn">Add to Schedule</button>
                        </div>
                    </form>

                    <div class="schedule-summary">
                        <h3>Today's Summary</h3>
                        <div id="todaySummary"></div>
                    </div>

                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Task</th>
                                <th>Description</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
        // Get current user
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        
        if (!currentUser || currentUser.role !== 'employee') {
            window.location.href = 'index.html';
        }

        // Load data on page load
        window.onload = function() {
            loadDashboardStats();
            loadTasks();
            loadSentTo();
            loadSchedule();
            loadTaskSelect();
            loadProjectSelect();
            loadEmployeeSelectForward();
            updateEmployeeUI();
        };

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update active menu item
            document.querySelectorAll('.menu-bar a').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load section specific data
            if (sectionId === 'dashboard') {
                loadDashboardStats();
            } else if (sectionId === 'tasks') {
                loadTasks();
            } else if (sectionId === 'forward-project') {
                loadProjectSelect();
            } else if (sectionId === 'sent-to') {
                loadSentTo();
            } else if (sectionId === 'schedule') {
                loadSchedule();
                loadTaskSelect();
            }
        }

        function loadDashboardStats() {
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            const userTasks = assignments.filter(task => task.employeeUsername === currentUser.username);
            const totalTasks = userTasks.length;
            const inProgressTasks = userTasks.filter(task => task.status === 'In Progress').length;
            const completedTasks = userTasks.filter(task => task.status === 'Completed').length;

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
        }

        function loadTasks() {
            const tableBody = document.querySelector('#tasksTable tbody');
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            const userTasks = assignments.filter(task => task.employeeUsername === currentUser.username);
            
            tableBody.innerHTML = '';
            userTasks.forEach((task, index) => {
                const row = document.createElement('tr');
                const filesHtml = task.files && task.files.length > 0 
                    ? task.files.map(file => `
                        <div class="file-item">
                            <span class="file-icon">📎</span>
                            <a href="#" onclick="downloadFile('${file.name}', '${file.data}')" class="file-link">${file.name}</a>
                        </div>
                    `).join('')
                    : '<span class="empty-state">No files</span>';
                
                row.innerHTML = `
                    <td>${task.project}</td>
                    <td>${task.task}</td>
                    <td>${task.dueDate}</td>
                    <td><span class="status-badge status-${task.status.toLowerCase().replace(' ', '-')}">${task.status}</span></td>
                    <td>${filesHtml}</td>
                    <td>
                        <button class="btn" onclick="updateTaskStatus(${index})">Update Status</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function downloadFile(fileName, fileData) {
            try {
                // Convert base64 to blob
                const byteCharacters = atob(fileData.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray]);

                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Error downloading file. Please try again.');
            }
        }

        function updateTaskStatus(taskIndex) {
            const assignments = JSON.parse(localStorage.getItem('assignments'));
            const task = assignments[taskIndex];
            
            if (task.status === 'Completed') {
                alert('Task is already completed');
                return;
            }
            
            const newStatus = task.status === 'In Progress' ? 'Completed' : 'In Progress';
            
            task.status = newStatus;
            localStorage.setItem('assignments', JSON.stringify(assignments));
            
            if (newStatus === 'Completed') {
                // Add completion timestamp
                task.completedDate = new Date().toISOString();
            }
            
            loadTasks(); // Refresh the tasks list
            
            if (newStatus === 'Completed') {
                alert('Task marked as completed!');
            } else {
                alert('Task status updated to In Progress');
            }
        }

        function logout() {
            // Clear all session storage
            sessionStorage.clear();
            
            // Clear all local storage items related to the current user
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
                const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
                const forwardedProjects = JSON.parse(localStorage.getItem('forwardedProjects')) || [];
                
                // Remove user-specific data
                const updatedAssignments = assignments.filter(task => task.employeeUsername !== currentUser.username);
                const updatedSchedules = schedules.filter(schedule => schedule.employeeUsername !== currentUser.username);
                const updatedForwardedProjects = forwardedProjects.filter(project => project.forwardedBy !== currentUser.username);
                
                // Update localStorage
                localStorage.setItem('assignments', JSON.stringify(updatedAssignments));
                localStorage.setItem('schedules', JSON.stringify(updatedSchedules));
                localStorage.setItem('forwardedProjects', JSON.stringify(updatedForwardedProjects));
            }
            
            // Redirect to login page
            window.location.replace('index.html');
        }

        // Schedule Functions
        function loadTaskSelect() {
            const taskSelect = document.getElementById('taskSelect');
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            // Clear existing options except the first one
            while (taskSelect.options.length > 1) {
                taskSelect.remove(1);
            }
            
            // Add task options
            assignments.forEach(task => {
                if (task.employeeUsername === currentUser.username && task.status !== 'Completed') {
                    const option = document.createElement('option');
                    option.value = task.project + '|' + task.task;
                    option.textContent = `${task.project} - ${task.task}`;
                    taskSelect.appendChild(option);
                }
            });
        }

        function loadSchedule() {
            const tableBody = document.querySelector('#scheduleTable tbody');
            const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            // Filter schedules for current user
            const userSchedules = schedules.filter(schedule => 
                schedule.employeeUsername === currentUser.username
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = '';
            userSchedules.forEach((schedule, index) => {
                const duration = calculateDuration(schedule.startTime, schedule.endTime);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(schedule.date).toLocaleDateString()}</td>
                    <td>${schedule.startTime}</td>
                    <td>${schedule.endTime}</td>
                    <td>${schedule.task}</td>
                    <td>${schedule.description}</td>
                    <td>${duration}</td>
                    <td>
                        <button class="btn" onclick="removeSchedule(${index})">Remove</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update today's summary
            updateTodaySummary(userSchedules);
        }

        function calculateDuration(startTime, endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const diff = end - start;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }

        function updateTodaySummary(schedules) {
            const today = new Date().toISOString().split('T')[0];
            const todaySchedules = schedules.filter(schedule => schedule.date === today);
            
            const totalHours = todaySchedules.reduce((total, schedule) => {
                const duration = calculateDuration(schedule.startTime, schedule.endTime);
                const [hours] = duration.split('h');
                return total + parseInt(hours);
            }, 0);

            const summaryDiv = document.getElementById('todaySummary');
            summaryDiv.innerHTML = `
                <p>Total Hours Today: ${totalHours} hours</p>
                <p>Tasks Completed: ${todaySchedules.length}</p>
            `;
        }

        function removeSchedule(index) {
            if (confirm('Are you sure you want to remove this schedule entry?')) {
                const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                const userSchedules = schedules.filter(schedule => 
                    schedule.employeeUsername === currentUser.username
                );
                
                userSchedules.splice(index, 1);
                
                const otherSchedules = schedules.filter(schedule => 
                    schedule.employeeUsername !== currentUser.username
                );
                
                localStorage.setItem('schedules', JSON.stringify([...otherSchedules, ...userSchedules]));
                loadSchedule();
            }
        }

        // Add event listener for schedule form
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const workDate = document.getElementById('workDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const taskSelect = document.getElementById('taskSelect');
            const workDescription = document.getElementById('workDescription').value;
            
            if (!workDate || !startTime || !endTime || !taskSelect.value || !workDescription) {
                alert('Please fill all fields');
                return;
            }
            
            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }
            
            const [project, task] = taskSelect.value.split('|');
            const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            schedules.push({
                employeeUsername: currentUser.username,
                employeeName: currentUser.name || currentUser.username,
                date: workDate,
                startTime: startTime,
                endTime: endTime,
                project: project,
                task: task,
                description: workDescription,
                created: new Date().toISOString()
            });
            
            localStorage.setItem('schedules', JSON.stringify(schedules));
            
            // Clear form
            this.reset();
            
            // Refresh schedule
            loadSchedule();
            loadTaskSelect();
            
            alert('Schedule entry added successfully!');
        });

        function loadSentTo() {
            const tableBody = document.querySelector('#sentToTable tbody');
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const forwardedProjects = JSON.parse(localStorage.getItem('forwardedProjects')) || [];
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            const sentTasks = assignments.filter(task => 
                task.employeeUsername === currentUser.username && 
                task.status === 'Completed'
            );
            
            tableBody.innerHTML = '';
            sentTasks.forEach(task => {
                // Find forwarded project info for this task
                const forwarded = forwardedProjects.find(fp => fp.project === task.project && fp.forwardedBy !== currentUser.username);
                let forwardedFrom = '';
                if (forwarded) {
                    const fromUser = users.find(u => u.username === forwarded.forwardedBy);
                    if (fromUser) {
                        forwardedFrom = `${fromUser.name || fromUser.username} (${fromUser.role})`;
                    } else {
                        forwardedFrom = `${forwarded.forwardedBy}`;
                    }
                } else {
                    forwardedFrom = 'N/A';
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.project}</td>
                    <td>${task.task}</td>
                    <td>${task.completedDate || 'N/A'}</td>
                    <td><span class="status-badge status-completed">Completed</span></td>
                    <td>${task.managerResponse || 'Pending Review'}</td>
                    <td>${forwardedFrom}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadProjectSelect() {
            const projectSelect = document.getElementById('projectSelect');
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            // Clear existing options except the first one
            while (projectSelect.options.length > 1) {
                projectSelect.remove(1);
            }
            
            // Get unique projects
            const uniqueProjects = [...new Set(assignments
                .filter(task => task.employeeUsername === currentUser.username)
                .map(task => task.project))];
            
            // Add project options
            uniqueProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelect.appendChild(option);
            });
        }

        function loadEmployeeSelectForward() {
            const employeeSelect = document.getElementById('employeeSelectForward');
            if (!employeeSelect) return;
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            // Clear existing options except the first one
            while (employeeSelect.options.length > 1) {
                employeeSelect.remove(1);
            }
            users.forEach(user => {
                if (user.role === 'employee' && user.username !== currentUser.username) {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.name || user.username;
                    employeeSelect.appendChild(option);
                }
            });
        }

        // Add event listener for forward project form
        document.getElementById('forwardProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const project = document.getElementById('projectSelect').value;
            const department = document.getElementById('departmentSelect').value;
            const employeeForward = document.getElementById('employeeSelectForward').value;
            const notes = document.getElementById('forwardNotes').value;
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (!project || !department || !notes) {
                alert('Please fill all fields');
                return;
            }
            
            const forwardedProjects = JSON.parse(localStorage.getItem('forwardedProjects')) || [];
            
            forwardedProjects.push({
                project: project,
                forwardedBy: currentUser.username,
                forwardedTo: department,
                forwardedToEmployee: employeeForward || null,
                notes: notes,
                forwardedDate: new Date().toISOString(),
                status: 'Pending'
            });
            
            localStorage.setItem('forwardedProjects', JSON.stringify(forwardedProjects));
            
            // Clear form
            this.reset();
            loadEmployeeSelectForward();
            
            alert('Project forwarded successfully!');
        });

        // Employee Details Box Logic
        function renderEmployeeDetails() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const row = document.getElementById('employeeScrollRow');
            row.innerHTML = '';
            if (currentUser && currentUser.role === 'employee') {
                const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
                const empTasks = assignments.filter(a => a.employeeUsername === currentUser.username);
                const overdue = empTasks.filter(a => a.dueDate && new Date(a.dueDate) < new Date() && a.status !== 'Completed').length;
                const initials = currentUser.name ? currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : currentUser.username.slice(0,2).toUpperCase();
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <div class="employee-avatar">${initials}</div>
                    <div class="employee-name">${currentUser.name || currentUser.username}</div>
                    <div class="employee-status">${empTasks.length} tasks${overdue ? `, <span style='color:#f72585'>${overdue} overdue</span>` : ''}</div>
                `;
                row.appendChild(card);
            }
        }

        // Calendar Logic
        let calendar;
        function renderCalendar() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const events = assignments.filter(a => a.employeeUsername === currentUser.username).map(a => ({
                title: (a.project ? a.project+': ' : '') + (a.task || ''),
                start: a.dueDate,
                description: a.task,
                status: a.status,
                backgroundColor: a.status === 'Completed' ? '#4cc9f0' : 
                               a.status === 'In Progress' ? '#06d6a0' : '#ffd166'
            }));
            if (calendar) calendar.destroy();
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                height: 600,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                eventClick: function(info) {
                    alert('Task: ' + info.event.title + '\nStatus: ' + (info.event.extendedProps.status || 'N/A'));
                }
            });
            calendar.render();
        }

        // Update both on load and after assigning a task
        function updateEmployeeUI() {
            renderCalendar();
            loadDashboardTasks();
            loadEmployeeSelectForward();
        }

        function loadDashboardTasks() {
            const tableBody = document.querySelector('#dashboardTasksTable tbody');
            const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            const userTasks = assignments.filter(task => task.employeeUsername === currentUser.username);
            
            tableBody.innerHTML = '';
            userTasks.forEach((task, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.project}</td>
                    <td>${task.task}</td>
                    <td>${task.dueDate}</td>
                    <td><span class="status-badge status-${task.status.toLowerCase().replace(' ', '-')}">${task.status}</span></td>
                    <td>
                        <button class="btn" onclick="updateTaskStatus(${index})">Update Status</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Call on page load
        window.onload = updateEmployeeUI;
    </script>
</body>
</html>